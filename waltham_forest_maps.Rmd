---
title: "Waltham Forest Concentration MAps"
author: "James Smith"
output:
  html_document:
    toc: true
    toc_depth: 4
date: "`r format(Sys.time(), '%Y-%m%-%d %H%:%M')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs", output_file ="maps.html") })
---

This document creates a number of maps of air quality in Waltham Forest.

### Set-up
```{r setup, include=FALSE}
rm(list=ls())

### Loading any missing libraries

library(rvest)
library(stringr)
library(raster)
library(rgdal)
library(rgeos)
devtools::install_github("tidyverse/ggplot2")
library(ggplot2)
library(sf)
library(rmarkdown)
library(rasterVis)
```

### Data importing

Get the ward boundaries

```{r Get ward boundaries}
ukgrid      <- "+init=epsg:27700"
latlong     <- "+init=epsg:4326"

authorities <- data.frame(authority_name = c('Waltham Forest'),
                          stringsAsFactors = F)

###  getting a geojson of UK wards from governmant data portal

url                 <- 'https://opendata.arcgis.com/datasets/d5c9c1d89a5a44e9a7f88f182ffe5ba2_2.geojson'
wards               <- readOGR(dsn = url, layer = "d5c9c1d89a5a44e9a7f88f182ffe5ba2_2")
wards               <- spTransform(wards, ukgrid)
wards               <- wards[wards$lad16nm %in% authorities$authority_name,]

```

Import the ready air quality files

```{r import_ready_air_quality}

no2_2013_raster  <- raster('air_quality/no2_2013.asc')
nox_2013_raster  <- raster('air_quality/nox_2013.asc')
pm25_2013_raster <- raster('air_quality/pm25_2013.asc')
pm10_2013_raster <- raster('air_quality/pm10_2013.asc')
  
no2_2020_raster  <- raster('air_quality/no2_2020.asc')
nox_2020_raster  <- raster('air_quality/nox_2020.asc')
pm10_2020_raster <- raster('air_quality/pm10_2020.asc')
pm25_2020_raster <- raster('air_quality/pm25_2020.asc')
```

Now import the ones that need cropping and re-gridding

```{r import_not_ready_air_quality}

no2_2020_minus_no_sc_raster       <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/no22013mnosc/w001001.adf')
nox_2020_minus_no_sc_raster       <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/nox2013mnosc/w001001.adf')
pm25_2020_minus_no_sc_raster      <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/pm252013mnosc/w001001.adf')
pm10_2020_minus_no_sc_raster      <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/pm102013mnosc/w001001.adf')

crs(no2_2020_minus_no_sc_raster)  <- CRS(ukgrid)
crs(nox_2020_minus_no_sc_raster)  <- CRS(ukgrid)
crs(pm25_2020_minus_no_sc_raster) <- CRS(ukgrid)
crs(pm10_2020_minus_no_sc_raster) <- CRS(ukgrid)

no2_2020_sc3_minus_sc1_raster  <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/no220sc3msc1/w001001.adf')
nox_2020_sc3_minus_sc1_raster  <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/nox20sc3msc1/w001001.adf')
pm25_2020_sc3_minus_sc1_raster <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/pm2520sc3msc1/w001001.adf')
pm10_2020_sc3_minus_sc1_raster <- raster('Z:/Projects/AutomatedAirPollutionMapping/CHASE/R_Mapping/Output/WF/Raster/pm1020sc3msc1/w001001.adf')

crs(no2_2020_sc3_minus_sc1_raster)  <- CRS(ukgrid)
crs(nox_2020_sc3_minus_sc1_raster)  <- CRS(ukgrid)
crs(pm25_2020_sc3_minus_sc1_raster) <- CRS(ukgrid)
crs(pm10_2020_sc3_minus_sc1_raster) <- CRS(ukgrid)

no2_2020_minus_no_sc_raster    <- crop(no2_2020_minus_no_sc_raster,    wards)
nox_2020_minus_no_sc_raster    <- crop(nox_2020_minus_no_sc_raster,    wards)
pm25_2020_minus_no_sc_raster   <- crop(pm25_2020_minus_no_sc_raster,   wards)
pm10_2020_minus_no_sc_raster   <- crop(pm10_2020_minus_no_sc_raster,   wards)

no2_2020_sc3_minus_sc1_raster  <- crop(no2_2020_sc3_minus_sc1_raster,  wards)
nox_2020_sc3_minus_sc1_raster  <- crop(nox_2020_sc3_minus_sc1_raster,  wards)
pm25_2020_sc3_minus_sc1_raster <- crop(pm25_2020_sc3_minus_sc1_raster, wards)
pm10_2020_sc3_minus_sc1_raster <- crop(pm10_2020_sc3_minus_sc1_raster, wards)

no2_2020_minus_no_sc_raster    <- mask(no2_2020_minus_no_sc_raster,    wards)
nox_2020_minus_no_sc_raster    <- mask(nox_2020_minus_no_sc_raster,    wards)
pm25_2020_minus_no_sc_raster   <- mask(pm25_2020_minus_no_sc_raster,   wards)
pm10_2020_minus_no_sc_raster   <- mask(pm10_2020_minus_no_sc_raster,   wards)

no2_2020_sc3_minus_sc1_raster  <- mask(no2_2020_sc3_minus_sc1_raster,  wards)
nox_2020_sc3_minus_sc1_raster  <- mask(nox_2020_sc3_minus_sc1_raster,  wards)
pm25_2020_sc3_minus_sc1_raster <- mask(pm25_2020_sc3_minus_sc1_raster, wards)
pm10_2020_sc3_minus_sc1_raster <- mask(pm10_2020_sc3_minus_sc1_raster, wards)

no2_2020_minus_no_sc_raster    <- disaggregate(no2_2020_minus_no_sc_raster, fact = 4, method="bilinear")
nox_2020_minus_no_sc_raster    <- disaggregate(nox_2020_minus_no_sc_raster, fact = 4, method="bilinear")
pm25_2020_minus_no_sc_raster   <- disaggregate(pm25_2020_minus_no_sc_raster, fact = 4, method="bilinear")
pm10_2020_minus_no_sc_raster   <- disaggregate(pm10_2020_minus_no_sc_raster, fact = 4, method="bilinear")

no2_2020_sc3_minus_sc1_raster  <- disaggregate(no2_2020_sc3_minus_sc1_raster, fact = 4, method="bilinear")
nox_2020_sc3_minus_sc1_raster  <- disaggregate(nox_2020_sc3_minus_sc1_raster, fact = 4, method="bilinear")
pm25_2020_sc3_minus_sc1_raster <- disaggregate(pm25_2020_sc3_minus_sc1_raster, fact = 4, method="bilinear")
pm10_2020_sc3_minus_sc1_raster <- disaggregate(pm10_2020_sc3_minus_sc1_raster, fact = 4, method="bilinear")

```

### Mapping 

```{r make_pm25_maps}

source('https://raw.githubusercontent.com/KCL-ERG/colour_schemes/master/pm25_laei2013_colours_breaks.R')
source('https://raw.githubusercontent.com/KCL-ERG/colour_schemes/master/no2_laei2013_colours_breaks.R')
source('https://raw.githubusercontent.com/KCL-ERG/colour_schemes/master/pm10_laei2013_colours_breaks.R')

```

2013 and 2020 standard air quality outputs

NO2 2013 and 2020

```{r normal_no2_output, warning=F, message=F}
png('png_outputs/no2_2013_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(no2_2013_raster,
          maxpixels = no2_2013_raster@ncols/2 * no2_2013_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(no2_2013_raster)

png('png_outputs/no2_2020_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(no2_2020_raster,
          maxpixels = no2_2020_raster@ncols/2 * no2_2020_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(no2_2020_raster)

```

NOX 2013 and 2020

```{r normal_nox_outputs, warning=F, message=F}

png('png_outputs/nox_2013_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(nox_2013_raster,
          maxpixels = nox_2020_raster@ncols/2 * nox_2020_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(nox_2013_raster)

png('png_outputs/nox_2020_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(nox_2020_raster,
          maxpixels = nox_2020_raster@ncols/2 * nox_2020_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(nox_2020_raster)

```

PM25 2013 and 2020

```{r normal_pm25_outputs, warning=F, message=F}

png('png_outputs/pm25_2013_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(pm25_2013_raster,
          maxpixels = pm25_2013_raster@ncols * pm25_2013_raster@nrows,
          margin = FALSE,
          colorkey = list(
            at = seq(min(pm25_laei2013_breaks), max(pm25_laei2013_breaks), length = 12),
            space = 'right',
            labels = list(at=seq(min(pm25_laei2013_breaks), max(pm25_laei2013_breaks), length = 12), 
                          labels = paste(" \n \n ",pm25_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = pm25_laei2013_colours,
          at = pm25_laei2013_breaks)

dev.off()

rm(pm25_2013_raster)

png('png_outputs/pm25_2020_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(pm25_2020_raster,
          maxpixels = pm25_2020_raster@ncols * pm25_2020_raster@nrows,
          margin = FALSE,
          colorkey = list(
            at = seq(min(pm25_laei2013_breaks), max(pm25_laei2013_breaks), length = 12),
            space = 'right',
            labels = list(at=seq(min(pm25_laei2013_breaks), max(pm25_laei2013_breaks), length = 12), 
                          labels = paste(" \n \n ",pm25_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = pm25_laei2013_colours,
          at = pm25_laei2013_breaks)

dev.off()

rm(pm25_2020_raster)

```

PM10 2013 and 2020

```{r normal_pm10_outputs, warning=F, message=F}

png('png_outputs/pm10_2013_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(pm10_2013_raster,
          maxpixels = pm10_2013_raster@ncols * pm10_2013_raster@nrows,
          margin = FALSE,
          colorkey = list(
            at = seq(min(pm10_laei2013_breaks), max(pm10_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(pm10_laei2013_breaks), max(pm10_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",pm10_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = pm10_laei2013_colours,
          at = pm10_laei2013_breaks)

dev.off()

rm(pm10_2013_raster)

png('png_outputs/pm10_2020_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(pm10_2020_raster,
          maxpixels = pm10_2020_raster@ncols * pm10_2020_raster@nrows,
          margin = FALSE,
          colorkey = list(
            at = seq(min(pm10_laei2013_breaks), max(pm10_laei2013_breaks), length = 17),
            space = 'right',
            labels = list(at=seq(min(pm10_laei2013_breaks), max(pm10_laei2013_breaks), length = 17), 
                          labels = paste(" \n \n ",pm10_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = pm10_laei2013_colours,
          at = pm10_laei2013_breaks)

dev.off()

rm(pm10_2020_raster)

```

2020 Air Quality scenarios

```{r convert_the_to_positives}
no2_2020_minus_no_sc_raster    <- no2_2020_minus_no_sc_raster    * no2_2020_minus_no_sc_raster
no2_2020_sc3_minus_sc1_raster  <- no2_2020_sc3_minus_sc1_raster  * no2_2020_sc3_minus_sc1_raster

nox_2020_minus_no_sc_raster    <- nox_2020_minus_no_sc_raster    * nox_2020_minus_no_sc_raster
nox_2020_sc3_minus_sc1_raster  <- nox_2020_sc3_minus_sc1_raster  * nox_2020_sc3_minus_sc1_raster

pm25_2020_minus_no_sc_raster   <- pm25_2020_minus_no_sc_raster   * pm25_2020_minus_no_sc_raster
pm25_2020_sc3_minus_sc1_raster <- pm25_2020_sc3_minus_sc1_raster * pm25_2020_sc3_minus_sc1_raster

pm10_2020_minus_no_sc_raster   <- pm10_2020_minus_no_sc_raster   * pm10_2020_minus_no_sc_raster
pm10_2020_sc3_minus_sc1_raster <- pm10_2020_sc3_minus_sc1_raster * pm10_2020_sc3_minus_sc1_raster

```

New colour scheme for NO2 minus no school run

```{r}
no2_laei2013_breaks  <- c(0,format(round(quantile(no2_2020_minus_no_sc_raster, seq(0,1,length.out = 10)),7), scientific=F)) #11

no2_laei2013_colours <- c("#064AF4", "#0C95E9", "#19CFD2", "#82FDCF", "#68DE85", "#A4EB50", "#FFFF80", "#FFD600", "#FFAD5B", "#F97C00") #10 (one less above)

no2_laei2013_labels  <- c("", paste(no2_laei2013_breaks[1:length(no2_laei2013_breaks)-1], "-", 
                                    no2_laei2013_breaks[2:length(no2_laei2013_breaks)])) #11 (same as breaks)
```

NO2 minus no school run

```{r no_school_run_no2_output, warning=F, message=F}
png('png_outputs/no2_2020_minus_no_school_run_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(no2_2020_minus_no_sc_raster,
          maxpixels = no2_2020_minus_no_sc_raster@ncols/2 * no2_2020_minus_no_sc_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(no2_2020_minus_no_sc_raster)
```

New colour scheme for NO2 scenario 3 minus scenario 1

```{r}
no2_laei2013_breaks  <- c(0,format(round(quantile(no2_2020_sc3_minus_sc1_raster, seq(0,1,length.out = 5)),7), scientific=F)) #11

no2_laei2013_colours <- c("#064AF4", "#0C95E9", "#19CFD2", "#82FDCF", "#68DE85", "#A4EB50", "#FFFF80", "#FFD600", "#FFAD5B", "#F97C00") #10 (one less above)

no2_laei2013_labels  <- c("", paste(no2_laei2013_breaks[1:length(no2_laei2013_breaks)-1], "-", 
                                    no2_laei2013_breaks[2:length(no2_laei2013_breaks)])) #11 (same as breaks)
```

```{r}

png('png_outputs/no2_2020_sc3_minus_sc1_raster.png', width = 10, height = 8, units = 'in', res = 300)

levelplot(no2_2020_sc3_minus_sc1_raster,
          maxpixels = no2_2020_sc3_minus_sc1_raster@ncols/2 * no2_2020_sc3_minus_sc1_raster@nrows/2,
          margin = FALSE,
          colorkey = list(
            at = seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)),
            space = 'right',
            labels = list(at=seq(min(no2_laei2013_breaks), max(no2_laei2013_breaks), length = length(no2_laei2013_breaks)), 
                          labels = paste(" \n \n ",no2_laei2013_labels), 
                          font = 1,
                          cex = 1.5)
          ),
          par.settings = list(
            axis.line =list( col = 'transparent')
          ),
          scales = list(draw = FALSE),
          col.regions = no2_laei2013_colours,
          at = no2_laei2013_breaks)

dev.off()

rm(no2_2020_raster)

```
NOX minus no school run


PM25 minus no school run


PM10 minus no school run


pm25_laei2013_breaks            <-  4:15
pm25_laei2013_labels            <- c('0-4' = "#FFFFFF",
                                     '4-5' = "#01129C",
                                     '5-6' = "#0325D3",
                                     '6-7' = "#064AF4",
                                     '7-8' = "#0C95E9",
                                     '8-9' = "#19CFD2",
                                     '9-10' = "#82FDCF",
                                     '10-11' = "#68DE85",
                                     '11-12' = "#A4EB50",
                                     '12-13' = "#FFFF80",
                                     '13-14' = "#FFD600",
                                     '14-15' = '#F97C00')
pm25_factors                    <- c('0-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10', '10-11', '11-12','12-13','13-14', '14-15')


```


